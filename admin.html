<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gestión de archivos del sistema</title>
  <style>
    body { font-family: Segoe UI, Arial, sans-serif; background: #f5f3ff; margin: 0; padding: 0; }
    .container { max-width: 430px; margin: 40px auto; padding: 24px; background: #fff; border-radius: 16px; box-shadow: 0 4px 30px rgba(124, 58, 237, .18); }
    h2 { color: #6e38ce; text-align: center; margin-bottom: 16px; }
    .form-section { margin-bottom: 36px; }
    .inputfile {
      width: 100%; min-height: 68px; border: 2px dashed #7c3aed; border-radius: 10px;
      color: #5e5e5e; background: #f8f8fc; text-align: center; padding: 18px; cursor: pointer; font-size: 16px;
      transition: border-color .25s;
    }
    .inputfile:focus { border: 2px solid #5334ab; }
    .hidden { display: none; }
    .btn { margin: 8px 0; padding: 10px 22px; border: none; background: #7c3aed; color: #fff; border-radius: 7px; font-size: 18px;
      box-shadow: 1px 1px 18px rgba(124, 58, 237, .12); cursor: pointer; transition: background 0.12s;
    }
    .btn[disabled] { background: #aaa; cursor: wait; }
    .status-message {
      margin-bottom: 18px; text-align: center; padding: 8px 0;
      border-radius: 8px; font-size: 16px;
    }
    .status-message.success { background: #e9faf2; border: 1px solid #35b677; color: #2d7c57; }
    .status-message.error { background: #fff4f4; border: 1px solid #e04f4f; color: #b70000; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Gestión de archivos del sistema</h2>
    <div id="statusMsg" class="status-message hidden"></div>

    <div id="loginForm" class="form-section">
      <input type="password" placeholder="Contraseña de administrador" id="adminPwd" style="width:90%;padding:10px;margin-bottom:12px;border-radius:8px;border:1px solid #cdcdcd;font-size:17px;">
      <button class="btn" id="loginBtn">Iniciar sesión</button>
    </div>

    <div id="adminPanel" class="form-section hidden">
      <div>
        <label for="gruposFile" class="inputfile" id="labelGrupos">Arrastra el archivo <b>grupos.xlsx</b> aquí o haz clic para seleccionar</label>
        <input id="gruposFile" type="file" accept=".xlsx" class="hidden">
        <button class="btn" id="uploadGruposBtn" disabled>Subir grupos.xlsx</button>
      </div>
      <div style="margin-top:15px;">
        <label for="ordenFile" class="inputfile" id="labelOrden">Arrastra el archivo <b>orden.xlsx</b> aquí o haz clic para seleccionar</label>
        <input id="ordenFile" type="file" accept=".xlsx" class="hidden">
        <button class="btn" id="uploadOrdenBtn" disabled>Subir orden.xlsx</button>
      </div>
      <button class="btn" style="background:#5e318b;margin-top:36px;" id="logoutBtn">Cerrar sesión</button>
    </div>
    <div style="text-align:center;color:#bbb;font-size:13px;margin-top:35px">ATOSA &middot; Admin &copy; 2025</div>
  </div>

  <script>
    // CONFIGURA TU URL DEL BACKEND:
    const API_BASE = 'https://backend-aqb5.onrender.com';
    // -------- CÓDIGO JS CORREGIDO --------

    // Utilidades simples
    function showMessage(msg, type = 'success') {
      const el = document.getElementById('statusMsg');
      el.textContent = msg;
      el.className = `status-message ${type}`;
      el.classList.remove('hidden');
      setTimeout(() => el.classList.add('hidden'), 6200);
    }
    function showLoginForm() {
      document.getElementById('loginForm').classList.remove('hidden');
      document.getElementById('adminPanel').classList.add('hidden');
    }
    function showAdminPanel() {
      document.getElementById('loginForm').classList.add('hidden');
      document.getElementById('adminPanel').classList.remove('hidden');
    }

    // Login
    document.getElementById('loginBtn').onclick = async function() {
      const pwd = document.getElementById('adminPwd').value;
      if (!pwd) { showMessage('Pon la contraseña', 'error'); return; }
      this.disabled = true;
      try {
        const resp = await fetch(`${API_BASE}/admin/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include', // <<== ENVÍA COOKIES!
          body: JSON.stringify({ password: pwd })
        });
        const data = await resp.json();
        if (data.success) {
          showAdminPanel();
          showMessage('Acceso concedido', 'success');
        } else {
          showMessage(data.message || 'Contraseña incorrecta', 'error');
        }
      } catch (err) {
        showMessage('Error de red en login', 'error');
      }
      this.disabled = false;
    };

    // Estado autenticación al entrar
    window.addEventListener('DOMContentLoaded', async () => {
      try {
        const resp = await fetch(`${API_BASE}/admin/status`, {
          credentials: 'include'
        });
        const data = await resp.json();
        if (data.isAdmin) showAdminPanel();
        else showLoginForm();
      } catch {
        showLoginForm();
      }
    });

    // Logout
    document.getElementById('logoutBtn').onclick = async function() {
      await fetch(`${API_BASE}/admin/logout`, {
        method: 'POST',
        credentials: 'include'
      });
      showLoginForm();
      showMessage('Sesión cerrada', 'success');
    };

    // Subida de grupos.xlsx
    const gruposFile = document.getElementById('gruposFile');
    const uploadGruposBtn = document.getElementById('uploadGruposBtn');
    document.getElementById('labelGrupos').onclick = () => gruposFile.click();

    gruposFile.addEventListener('change', () => {
      uploadGruposBtn.disabled = !gruposFile.files[0];
      document.getElementById('labelGrupos').textContent =
        gruposFile.files[0] ? `Seleccionado: ${gruposFile.files[0].name}` : 'Arrastra el archivo grupos.xlsx aquí o haz clic para seleccionar';
    });

    uploadGruposBtn.onclick = async function() {
      if (!gruposFile.files[0]) return;
      this.disabled = true;
      const formData = new FormData();
      formData.append('archivo', gruposFile.files[0]);
      try {
        const resp = await fetch(`${API_BASE}/admin/upload-grupos`, {
          method: 'POST',
          body: formData,
          credentials: 'include'    // <<== ENVÍA COOKIES!
        });
        const data = await resp.json();
        if (data.success) {
          showMessage(`Archivo subido: ${data.registros} registros procesados.`, 'success');
          gruposFile.value = '';
          document.getElementById('labelGrupos').textContent = 'Arrastra el archivo grupos.xlsx aquí o haz clic para seleccionar';
        } else {
          showMessage(data.error || 'Error en la subida', 'error');
        }
      } catch {
        showMessage('Error de red al subir.', 'error');
      }
      this.disabled = false;
    };

    // Subida de orden.xlsx
    const ordenFile = document.getElementById('ordenFile');
    const uploadOrdenBtn = document.getElementById('uploadOrdenBtn');
    document.getElementById('labelOrden').onclick = () => ordenFile.click();

    ordenFile.addEventListener('change', () => {
      uploadOrdenBtn.disabled = !ordenFile.files[0];
      document.getElementById('labelOrden').textContent =
        ordenFile.files[0] ? `Seleccionado: ${ordenFile.files[0].name}` : 'Arrastra el archivo orden.xlsx aquí o haz clic para seleccionar';
    });

    uploadOrdenBtn.onclick = async function() {
      if (!ordenFile.files[0]) return;
      this.disabled = true;
      const formData = new FormData();
      formData.append('archivo', ordenFile.files[0]);
      try {
        const resp = await fetch(`${API_BASE}/admin/upload-orden`, {
          method: 'POST',
          body: formData,
          credentials: 'include'
        });
        const data = await resp.json();
        if (data.success) {
          showMessage(`Archivo subido: ${data.registros} registros procesados.`, 'success');
          ordenFile.value = '';
          document.getElementById('labelOrden').textContent = 'Arrastra el archivo orden.xlsx aquí o haz clic para seleccionar';
        } else {
          showMessage(data.error || 'Error en la subida', 'error');
        }
      } catch {
        showMessage('Error de red al subir', 'error');
      }
      this.disabled = false;
    };
  </script>
</body>
</html>
