<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Generador Excel ATOSA</title>
<style>
  body { font-family: sans-serif; max-width: 540px; margin: 30px auto; }
  label { font-weight: bold; }
  .campo { margin-bottom: 10px; }
  #progreso { width: 100%; height: 18px; }
</style>
</head>
<body>
<h2>Generar Listado de Productos ATOSA</h2>
<div class="campo">
  <label>Grupo:</label>
  <select id="grupo"></select>
</div>
<div class="campo">
  <label>Descuento (%):</label>
  <select id="descuento"><option>0</option><option>5</option><option>10</option></select>
</div>
<div class="campo">
  <label>Sin imágenes</label>
  <input type="checkbox" id="sinImagenes">
</div>
<div class="campo">
  <label>Origen imágenes:</label>
  <select id="origenFotos">
    <option value="local">Carpeta local (RÁPIDO)</option>
  </select>
</div>
<div class="campo">
  <label>Selecciona carpeta de imágenes: </label>
  <input type="file" id="carpeta" webkitdirectory directory multiple>
</div>
<button id="generar">Generar Excel</button>
<progress id="progreso" value="0" max="100"></progress>
<div id="estado"></div>
<script>
const API = "https://backend-aqb5.onrender.com";

// Carga grupos
fetch(API + "/api/grupos").then(r => r.json()).then(({ grupos }) => {
  const g = document.getElementById("grupo");
  grupos.forEach(gr => { g.innerHTML += `<option>${gr}</option>` });
});

// Gestiona generación del Excel
document.getElementById("generar").onclick = async function() {
  const grupo = document.getElementById("grupo").value;
  const descuento = parseInt(document.getElementById("descuento").value, 10);
  const sinImagenes = document.getElementById("sinImagenes").checked;
  const origenFotos = document.getElementById("origenFotos").value;
  // Extrae nombres de imágenes locales seleccionadas
  const files = Array.from(document.getElementById("carpeta").files);
  const nombres = files.map(f => f.name.toLowerCase());
  setEstado("Preparando...");
  // 1. Solicita el Job y qué fotos faltan
  const resp = await fetch(API + "/api/genera-excel-final-async", {
    method: "POST", headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ grupo, descuento, sinImagenes, origenFotos, fotosDisponibles: nombres })
  });
  const data = await resp.json();
  if (data.requiredFotos && data.requiredFotos.length) {
    // Sube solo faltantes
    setEstado(`Subiendo ${data.requiredFotos.length} fotos...`);
    let form = new FormData();
    files.filter(f => data.requiredFotos.includes(f.name.toLowerCase())).forEach(f => form.append("fotos", f));
    await fetch(API + "/api/subir-fotos/" + data.jobId, { method: "POST", body: form });
  }
  setEstado("Generando Excel...");
  consultaProgreso(data.jobId);
};

function setEstado(txt) {
  document.getElementById("estado").textContent = txt;
}

async function consultaProgreso(jobId) {
  let prog = document.getElementById("progreso");
  let intervalo = setInterval(async () => {
    const res = await fetch(API + "/api/progreso/" + jobId);
    let data = await res.json();
    prog.value = data.progress || 0;
    setEstado(data.error ? "Error: " + data.error : `Progreso: ${data.progress}%`);
    if (data.progress >= 100 && !data.error) {
      clearInterval(intervalo);
      // Descarga el Excel
      setEstado("¡Listo para descargar!");
      const resp = await fetch(API + "/api/descarga-excel/" + jobId);
      const blob = await resp.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = data.filename || "listado.xlsx";
      a.click();
      setEstado("Descarga completada");
    }
    if (data.error) clearInterval(intervalo);
  }, 1200);
}
</script>
</body>
</html>
