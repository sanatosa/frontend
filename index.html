<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Generador Excel ATOSA</title>
<style>
  body { font-family: sans-serif; max-width: 540px; margin: 30px auto; }
  label { font-weight: bold; }
  .campo { margin-bottom: 10px; }
  #progreso { width: 100%; height: 18px; }
  .aviso { color: #b91c1c; font-weight: bold; margin-top: 10px; margin-bottom: 15px; }
</style>
</head>
<body>
<h2>Generar Listado de Productos ATOSA</h2>
<div class="campo">
  <label>Grupo:</label>
  <select id="grupo"></select>
</div>
<div class="campo">
  <label>Idioma:</label>
  <select id="idioma">
    <option value="Español">Español</option>
    <option value="Inglés">Inglés</option>
    <option value="Francés">Francés</option>
    <option value="Italiano">Italiano</option>
  </select>
</div>
<div class="campo">
  <label>Descuento (%):</label>
  <select id="descuento">
    <option>0</option><option>1</option><option>2</option><option>3</option>
    <option>4</option><option>5</option><option>6</option><option>7</option><option>8</option>
  </select>
</div>
<div class="campo">
  <label>Solo artículos en stock</label>
  <input type="checkbox" id="soloStock">
</div>
<div class="campo">
  <label>Sin imágenes</label>
  <input type="checkbox" id="sinImagenes">
</div>
<div class="campo">
  <label>Origen de imágenes</label>
  <select id="origenFotos" disabled>
    <option value="api">API de Atosa (MUY LENTO)</option>
  </select>
</div>
<div class="aviso">
  El uso de la API es <strong>MUY lento</strong> y puede tardar varios minutos en generar el Excel.
</div>
<button id="generar">Generar Excel</button>
<progress id="progreso" value="0" max="100"></progress>
<div id="estado"></div>
<script>
const API = "https://backend-aqb5.onrender.com";

fetch(API + "/api/grupos").then(r => r.json()).then(({ grupos }) => {
  const g = document.getElementById("grupo");
  grupos.forEach(gr => { g.innerHTML += `<option>${gr}</option>` });
});

document.getElementById("generar").onclick = async function() {
  const grupo = document.getElementById("grupo").value;
  const descuento = parseInt(document.getElementById("descuento").value, 10);
  const idioma = document.getElementById("idioma").value;
  const soloStock = document.getElementById("soloStock").checked;
  const sinImagenes = document.getElementById("sinImagenes").checked;
  setEstado("Iniciando generación...");
  fetch(API + "/api/genera-excel-final-async", {
    method: "POST", headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ grupo, descuento, idioma, soloStock, sinImagenes, origenFotos: "api" })
  })
  .then(r => r.json())
  .then(data => {
    setEstado("Generando Excel...");
    consultaProgreso(data.jobId);
  })
  .catch(() => setEstado("Error iniciando el proceso"));
};

function setEstado(txt) { document.getElementById("estado").textContent = txt; }

async function consultaProgreso(jobId) {
  let prog = document.getElementById("progreso");
  let intervalo = setInterval(async () => {
    const res = await fetch(API + "/api/progreso/" + jobId);
    let data = await res.json();
    prog.value = data.progress || 0;
    setEstado(data.error ? "Error: " + data.error : `Progreso: ${data.progress}%`);
    if (data.progress >= 100 && !data.error) {
      clearInterval(intervalo);
      setEstado("¡Listo para descargar!");
      const resp = await fetch(API + "/api/descarga-excel/" + jobId);
      const blob = await resp.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = data.filename || "listado.xlsx";
      a.click();
      setEstado("Descarga completada");
    }
    if (data.error) clearInterval(intervalo);
  }, 1200);
}
</script>
</body>
</html>
