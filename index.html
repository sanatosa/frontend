<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Generador de Excel B2B ATOSA</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; }
    h1 { font-size: 2em; }
    label { font-weight: bold; margin-top: 12px; display: block;}
    select, input[type=email], button { font-size: 16px; margin-top:6px;}
    #progreso { margin-left: 14px; color: #7C3AED; font-weight:bold;}
    #descargar { margin-left:16px; }
    #cambios-articulos { background:#f9f9fa; margin:24px 0 5px; padding:10px 14px; border-radius:7px; }
    hr { margin:38px 0 18px;}
  </style>
</head>
<body>
  <h1>Generador de Excel B2B ATOSA</h1>
  <form id="excel-form">
    <label for="grupo">Grupo</label>
    <select id="grupo" name="grupo" required>
      <option>Cargando grupos...</option>
    </select>

    <label for="idioma">Idioma</label>
    <select id="idioma">
      <option>Español</option>
      <option>Inglés</option>
      <option>Francés</option>
      <option>Italiano</option>
    </select>

    <label for="descuento">Descuento</label>
    <select id="descuento">
      <option value="0">Sin descuento</option>
      <option value="1">1%</option>
      <option value="2">2%</option>
      <option value="3">3%</option>
      <option value="4">4%</option>
      <option value="5">5%</option>
      <option value="6">6%</option>
      <option value="7">7%</option>
      <option value="8">8%</option>
    </select>

    <div style="margin:10px 0 6px;">
      <label style="font-weight:normal;display:inline;"><input type="checkbox" id="soloStock"> Solo en stock</label>
      <label style="font-weight:normal;display:inline;margin-left:22px;"><input type="checkbox" id="sinImagenes"> Sin imágenes</label>
    </div>

    <label for="email" style="margin-bottom:0;">Email para recibir el archivo (opcional)</label>
    <input type="email" id="email" style="width:295px" autocomplete="off">

    <br>
    <button type="submit" style="background: #7C3AED; color: #fff; border-radius:6px; padding:9px 20px; border: none; font-size: 17px;">Generar Excel</button>
    <span id="progreso"></span>
    <a id="descargar" style="display:none;">Descargar Excel</a>
  </form>

  <hr>

  <!-- NUEVO: Bloque separado para histórico, después del resto -->
  <button id="ver-cambios" style="background: #333; color:#fff; border-radius:4px; font-size:15px; padding: 7px 16px; border:none;">Ver cambios de artículos</button>
  <div id="cambios-articulos"></div>

  <script>
    // Carga dinámica de grupos al arrancar
    async function cargarGrupos() {
      try {
        const resp = await fetch('/api/grupos');
        const data = await resp.json();
        const sel = document.getElementById('grupo');
        sel.innerHTML = '';
        data.grupos.forEach(grupo => {
          const opt = document.createElement('option');
          opt.value = grupo;
          opt.textContent = grupo;
          sel.appendChild(opt);
        });
      } catch(e) {
        document.getElementById('grupo').innerHTML='<option>Sin conexión</option>';
      }
    }
    cargarGrupos();

    // Envío de formulario
    document.getElementById('excel-form').onsubmit = async function(e) {
      e.preventDefault();
      document.getElementById('progreso').textContent = 'Preparando generación...';
      document.getElementById('descargar').style.display = 'none';
      const body = {
        grupo: document.getElementById('grupo').value,
        idioma: document.getElementById('idioma').value,
        descuento: parseInt(document.getElementById('descuento').value, 10),
        soloStock: document.getElementById('soloStock').checked,
        sinImagenes: document.getElementById('sinImagenes').checked,
      };
      const email = document.getElementById('email').value.trim();
      if (email) body.email = email;

      const resp = await fetch('/api/genera-excel-final-async', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      const data = await resp.json();
      if (data.jobId) {
        comprobarProgreso(data.jobId);
      } else {
        document.getElementById('progreso').textContent = 'Error al iniciar la generación.';
      }
    };

    // Seguimiento de progreso
    async function comprobarProgreso(jobId) {
      const progreso = document.getElementById('progreso');
      const enlace = document.getElementById('descargar');
      progreso.textContent = 'Preparando archivo...';
      let intv = setInterval(async () => {
        const res = await fetch('/api/progreso/' + jobId);
        const dat = await res.json();
        progreso.textContent = `Progreso: ${dat.progress || 0}% - ${dat.fase || ''}` + (dat.eta ? ` (ETA: ${dat.eta}s)` : '');
        if (dat.error) {
          clearInterval(intv);
          progreso.textContent = 'Error: ' + dat.error;
        }
        if (dat.progress === 100 && dat.filename) {
          clearInterval(intv);
          progreso.textContent = '¡Completado!';
          enlace.style.display = '';
          enlace.href = '/api/descarga-excel/' + jobId;
          enlace.download = dat.filename;
          enlace.textContent = 'Descargar Excel';
        }
      }, 1400);
    }

    // HISTÓRICO - BLOQUE INDEPENDIENTE
    document.getElementById('ver-cambios').onclick = async function() {
      const res = await fetch('/api/cambios-articulos');
      const data = await res.json();
      let html = `<p><b>${data.resumen.numAltas}</b> altas, <b>${data.resumen.numBajas}</b> bajas</p>`;
      html += "<b>Altas:</b><br>" + (data.nuevas.length ? data.nuevas.join(', ') : 'Ninguna') + "<br><br>";
      html += "<b>Bajas:</b><br>" + (data.bajas.length ? data.bajas.join(', ') : 'Ninguna');
      document.getElementById('cambios-articulos').innerHTML = html;
    };
  </script>
</body>
</html>
