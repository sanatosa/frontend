<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Generador de Excel B2B ATOSA</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; background: #fff; color: #222;}
    h1 { font-size: 2em; margin-bottom: 0.2em;}
    label { font-weight: bold; display:block; margin-top: 10px;}
    select, input[type=email] { width: 240px; padding: 3px;}
    button, select, input { font-size: 16px; margin-top:5px;}
    .btn { background: #7C3AED; color: #fff; border: none; border-radius: 6px; padding: 12px 24px;}
    #progreso { margin-left: 15px; font-weight: bold; }
    #descargar { margin-left: 1em; }
    #cambios-articulos { background: #f7f6fa; margin: 20px 0 5px; padding:15px 10px; border-radius:7px; }
  </style>
</head>
<body>
  <h1>Generador de Excel B2B ATOSA</h1>
  <form id="excel-form">
    <label for="grupo">Grupo</label>
    <select id="grupo" name="grupo" required>
      <option>Cargando grupos...</option>
    </select>
    <label for="idioma">Idioma</label>
    <select id="idioma">
      <option>Español</option>
      <option>Inglés</option>
      <option>Francés</option>
      <option>Italiano</option>
    </select>
    <label for="descuento">Descuento</label>
    <select id="descuento">
      <option value="0">Sin descuento</option>
      <option value="1">1%</option>
      <option value="2">2%</option>
      <option value="3">3%</option>
      <option value="4">4%</option>
      <option value="5">5%</option>
      <option value="6">6%</option>
      <option value="7">7%</option>
      <option value="8">8%</option>
    </select>
    <div style="margin-bottom:12px;margin-top:6px;">
      <label style="display:inline;font-weight:normal;"><input type="checkbox" id="soloStock"> Solo en stock</label>
      <label style="display:inline;font-weight:normal;margin-left:18px;"><input type="checkbox" id="sinImagenes"> Sin imágenes</label>
    </div>
    <label for="email" style="margin-bottom:0;">Email para recibir el archivo (opcional)</label>
    <input type="email" id="email" style="width:290px" placeholder="tu correo (opcional)">
    <br>
    <button type="submit" class="btn">Generar Excel</button>
    <span id="progreso"></span>
    <a id="descargar" style="display:none;">Descargar Excel</a>
  </form>

  <hr style="margin:32px 0 12px;">

  <div style="margin-bottom:8px;">
    <button id="ver-cambios" class="btn" style="padding: 7px 20px; font-size:15px; background:#333;">Ver cambios de artículos</button>
  </div>
  <div id="cambios-articulos"></div>

  <script>
    // Cargar grupos
    async function cargarGrupos() {
      const resp = await fetch('/api/grupos');
      const data = await resp.json();
      const sel = document.getElementById('grupo');
      sel.innerHTML = '';
      data.grupos.forEach(grupo => {
        const opt = document.createElement('option');
        opt.value = grupo;
        opt.textContent = grupo;
        sel.appendChild(opt);
      });
    }
    cargarGrupos();

    // Envío formulario
    document.getElementById('excel-form').onsubmit = async function(e) {
      e.preventDefault();
      document.getElementById('progreso').textContent = 'Preparando generación...';
      document.getElementById('descargar').style.display = 'none';
      const body = {
        grupo: document.getElementById('grupo').value,
        idioma: document.getElementById('idioma').value,
        descuento: parseInt(document.getElementById('descuento').value, 10),
        soloStock: document.getElementById('soloStock').checked,
        sinImagenes: document.getElementById('sinImagenes').checked,
      };
      const email = document.getElementById('email').value.trim();
      if (email) body.email = email;

      const resp = await fetch('/api/genera-excel-final-async', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      const data = await resp.json();
      if (data.jobId) {
        comprobarProgreso(data.jobId);
      } else {
        document.getElementById('progreso').textContent = 'Error al iniciar la generación.';
      }
    };

    // Progreso y descarga
    async function comprobarProgreso(jobId) {
      const progreso = document.getElementById('progreso');
      const enlace = document.getElementById('descargar');
      progreso.textContent = 'Preparando archivo...';
      let intv = setInterval(async () => {
        const res = await fetch('/api/progreso/' + jobId);
        const dat = await res.json();
        progreso.textContent = `Progreso: ${dat.progress || 0}% - ${dat.fase || ''}` + (dat.eta ? ` (ETA: ${dat.eta}s)` : '');
        if (dat.error) {
          clearInterval(intv);
          progreso.textContent = 'Error: ' + dat.error;
        }
        if (dat.progress === 100 && dat.filename) {
          clearInterval(intv);
          progreso.textContent = '¡Completado!';
          enlace.style.display = '';
          enlace.href = '/api/descarga-excel/' + jobId;
          enlace.download = dat.filename;
          enlace.textContent = 'Descargar Excel';
        }
      }, 1200);
    }

    // Consulta de cambios de artículos
    document.getElementById('ver-cambios').onclick = async function() {
      const res = await fetch('/api/cambios-articulos');
      const data = await res.json();
      let html = `<p><b>${data.resumen.numAltas}</b> altas, <b>${data.resumen.numBajas}</b> bajas</p>`;
      html += "<b>Altas:</b><br>" + (data.nuevas.length ? data.nuevas.join(', ') : 'Ninguna') + "<br>";
      html += "<b>Bajas:</b><br>" + (data.bajas.length ? data.bajas.join(', ') : 'Ninguna');
      document.getElementById('cambios-articulos').innerHTML = html;
    };
  </script>
</body>
</html>
