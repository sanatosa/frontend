// server.js — ATOSA Excel: cabecera morada, datos EAN font 10, imágenes encajadas, alto de fila 82.0 puntos Excel

const express = require('express');
const axios = require('axios');
const cors = require('cors');
const XLSX = require('xlsx');
const ExcelJS = require('exceljs');
const https = require('https');
const { v4: uuidv4 } = require('uuid');
const Jimp = require('jimp');
const pLimit = require('p-limit').default;
require('dotenv').config();
const nodemailer = require('nodemailer');

const app = express();

// --- Configuración CORS para Netlify frontend ---
app.use(cors({
  origin: 'https://webb2b.netlify.app',
  credentials: true,
  methods: ['GET', 'POST', 'OPTIONS']
}));
app.options('*', cors());
app.use(express.json());

// --- Config fijar alto de filas ---
const imagenPx = 110;
const filaAltura = 82.0; // ← Altura de fila Excel

const diccionario_traduccion = {
  Español: {
    codigo: "Código", descripcion: "Descripción", disponible: "Stock",
    ean13: "EAN", precioVenta: "Precio", umv: "UMV", imagen: "Imagen"
  },
  Inglés: {
    codigo: "Code", descripcion: "Description", disponible: "Available",
    ean13: "EAN", precioVenta: "Price", umv: "MOQ", imagen: "Image"
  },
  Francés: {
    codigo: "Code", descripcion: "Description", disponible: "Stock",
    ean13: "EAN", precioVenta: "Prix", umv: "MOQ", imagen: "Image"
  },
  Italiano: {
    codigo: "Codice", descripcion: "Descrizione", disponible: "Stock",
    ean13: "EAN", precioVenta: "Prezzo", umv: "MOQ", imagen: "Immagine"
  }
};

const usuarios_api = {
  Español:   { usuario: "amazon@espana.es", password: "0glLD6g7Dg" },
  Inglés:    { usuario: "ingles@atosa.es", password: "AtosaIngles" },
  Francés:   { usuario: "frances@atosa.es", password: "AtosaFrances" },
  Italiano:  { usuario: "italiano@atosa.es", password: "AtosaItaliano" }
};
const usuario8 = { usuario: "santi@tradeinn.com", password: "C8Zg1wqgfe" };
const jobs = {};

// --- NUEVA FUNCIONALIDAD: Cargar orden de artículos ---
let ordenArticulos = {};
function cargarOrdenArticulos() {
  try {
    const workbookOrden = XLSX.readFile('./orden.xlsx');
    const sheetOrden = workbookOrden.Sheets[workbookOrden.SheetNames[0]];
    const datosOrden = XLSX.utils.sheet_to_json(sheetOrden, { header: ['orden', 'codigo'] });
    ordenArticulos = {};
    datosOrden.forEach(row => {
      if (row.codigo && row.orden !== undefined) {
        ordenArticulos[row.codigo.toString().trim()] = parseInt(row.orden) || 999999;
      }
    });
    console.log(`Cargados ${Object.keys(ordenArticulos).length} artículos del archivo orden.xlsx`);
  } catch (error) {
    console.error('Error cargando orden.xlsx:', error.message);
    ordenArticulos = {};
  }
}

function ordenarArticulos(articulos) {
  return articulos.sort((a, b) => {
    const codigoA = a.codigo ? a.codigo.toString().trim() : '';
    const codigoB = b.codigo ? b.codigo.toString().trim() : '';
    const ordenA = ordenArticulos[codigoA] || 999999; // Si no existe, va al final
    const ordenB = ordenArticulos[codigoB] || 999999;
    if (ordenA === ordenB) {
      return codigoA.localeCompare(codigoB);
    }
    return ordenA - ordenB;
  });
}

// --- Al iniciar el servidor carga el orden del excel ---
cargarOrdenArticulos();

async function obtenerFotoArticuloAPI(codigo, usuario, password, intentos = 3) {
  for (let i = 0; i < intentos; i++) {
    try {
      const resp = await axios.get(`https://b2b.atosa.es:880/api/articulos/foto/${codigo}`, {
        auth: { username: usuario, password },
        timeout: 15000,
        httpsAgent: new https.Agent({ rejectUnauthorized: false }),
      });
      const fotos = resp.data.fotos;
      if (Array.isArray(fotos) && fotos.length > 0) {
        const buffer = Buffer.from(fotos[0], 'base64');
        if (buffer.length > 0) return buffer;
      }
    } catch (e) {
      console.log(`Intento ${i + 1} fallido para imagen ${codigo}:`, e.message);
      if (i < intentos - 1) await new Promise(r => setTimeout(r, 1000 * (i + 1)));
    }
  }
  return null;
}

function validarBuffer(buffer) {
  if (!buffer || buffer.length === 0) return false;
  const jpegHeader = buffer.slice(0, 2).toString('hex') === 'ffd8';
  const pngHeader = buffer.slice(0, 8).toString('hex') === '89504e470d0a1a0a';
  return jpegHeader || pngHeader;
}

async function crearImagenPorDefecto() {
  const img = new Jimp(imagenPx, imagenPx, '#f0f0f0');
  const font = await Jimp.loadFont(Jimp.FONT_SANS_16_BLACK);
  img.print(font, 10, imagenPx/2 - 10, 'Sin imagen');
  return await img.getBufferAsync(Jimp.MIME_JPEG);
}

async function enviarEmailConAdjunto(emailDestino, bufferExcel, filename) {
  const transporter = nodemailer.createTransport({
    service: 'gmail',
    auth: {
      user: process.env.EMAIL_USER,
      pass: process.env.EMAIL_PASS
    }
  });
  const mailOptions = {
    from: process.env.EMAIL_FROM,
    to: emailDestino,
    subject: 'Tu archivo Excel está listo',
    text: 'Adjuntamos el listado generado. ¡Gracias por usar la herramienta!',
    attachments: [
      { filename, content: bufferExcel }
    ]
  };
  try {
    await transporter.sendMail(mailOptions);
    console.log(`Email enviado a ${emailDestino}`);
  } catch (error) {
    console.error(`Error enviando email: ${error.message}`);
  }
}

// ------------------ NUEVO ENDPOINT: Proxy de artículos ATOSA ---------------------------
app.get('/api/articulos-todos', async (req, res) => {
  try {
    const resp = await axios.get('https://b2b.atosa.es:880/api/articulos/', {
      auth: {
        username: 'amazon@espana.es',
        password: '0glLD6g7Dg'
      },
      timeout: 70000,
      httpsAgent: new https.Agent({ rejectUnauthorized: false }),
    });
    res.json(resp.data);
  } catch (err) {
    res.status(500).json({ error: "No se pudieron obtener los artículos." });
  }
});

// ------------------ ENDPOINTS ---------------------------

// Grupos disponibles
app.get('/api/grupos', async (req, res) => {
  try {
    const workbook = XLSX.readFile('./grupos.xlsx');
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const grupos = XLSX.utils.sheet_to_json(sheet);
    const nombres = [...new Set(grupos.map(row => (row.grupo ? row.grupo.toString().trim() : null)).filter(gr => gr && gr.length > 0))].sort();
    res.json({ grupos: nombres });
  } catch (err) {
    res.status(500).json({ error: "No se pudieron obtener los grupos." });
  }
});

// Excel asincrónico (principal)
app.post('/api/genera-excel-final-async', async (req, res) => {
  try {
    const { grupo, idioma = "Español", descuento = 0, soloStock = false, sinImagenes = false, email } = req.body;
    const jobId = uuidv4();
    jobs[jobId] = { progress: 0, buffer: null, error: null, filename: null, startedAt: Date.now(), fase: "Preparando" };
    generarExcelAsync({ grupo, idioma, descuento, soloStock, sinImagenes, email }, jobId);
    res.json({ jobId });
  } catch (err) {
    res.status(500).json({ error: "Error iniciando la generación del Excel." });
  }
});

app.get('/api/progreso/:jobId', (req, res) => {
  const { jobId } = req.params;
  const job = jobs[jobId];
  if (!job) return res.status(404).json({ error: 'Trabajo no encontrado' });
  let eta = null;
  if (job.progress > 2 && job.progress < 99 && job.startedAt) {
    const elapsed = (Date.now() - job.startedAt) / 1000;
    const p = Math.max(job.progress, 1) / 100;
    const total = elapsed / p;
    eta = Math.max(0, Math.round(total - elapsed));
  }
  res.json({ progress: job.progress, error: job.error, filename: job.filename, eta, fase: job.fase });
});

app.get('/api/descarga-excel/:jobId', (req, res) => {
  const { jobId } = req.params;
  const job = jobs[jobId];
  if (!job || !job.buffer) return res.status(404).json({ error: 'Archivo no disponible.' });
  res.setHeader('Content-Disposition', `attachment; filename="${job.filename}"`);
  res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
  res.send(job.buffer);
});

// Generador asíncrono de Excel
async function generarExcelAsync(params, jobId) {
  // ... (todo el código original, inalterado)
  //   No se muestra aquí por espacio, pero es igual al tuyo original.
}

app.get('/', (req, res) => res.send('Servidor ATOSA backend funcionando.'));
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => console.log(`Escuchando en puerto ${PORT}`));
