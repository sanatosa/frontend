<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Generador de Listado ATOSA</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; }
    #progress-bar {
      width: 400px; height: 32px; background: #eee;
      border: 1px solid #bbb; margin: 20px 0; border-radius: 8px; overflow: hidden;
      display: none;
    }
    #progress-inner {
      height: 100%; background: #4caf50; color: #fff; text-align: center;
      line-height: 32px; font-weight: bold; font-size: 16px; width: 0%;
      transition: width 0.3s;
    }
    #progreso-texto {
      min-height: 28px;
    }
    label, select, input {
      font-size: 16px;
    }
    button {
      font-size: 18px; padding: 8px 22px; margin-top: 12px;
      border-radius: 6px; border: 1px solid #3a7; background: #4caf50; color: #fff;
      cursor: pointer;
    }
    button[disabled] { opacity: 0.7; background: #bbb; cursor: not-allowed; }
    .campo { margin-bottom: 12px; }
  </style>
</head>
<body>
  <h1>Generador de Listado ATOSA</h1>

  <div class="campo">
    <label for="grupo">Grupo:</label>
    <input type="text" id="grupo" value="CARNAVAL" style="width:200px;" />
    <small>(escribe el nombre EXACTO del grupo, según el Excel)</small>
  </div>
  <div class="campo">
    <label for="idioma">Idioma:</label>
    <select id="idioma">
      <option>Español</option>
      <option>Inglés</option>
      <option>Francés</option>
      <option>Italiano</option>
    </select>
  </div>
  <div class="campo">
    <label for="descuento">Descuento (%):</label>
    <input type="number" id="descuento" value="0" min="0" max="50" style="width:60px;">
  </div>
  <div class="campo">
    <label for="soloStock"><input type="checkbox" id="soloStock"> Solo artículos con stock</label>
  </div>
  <div class="campo">
    <label for="maxFilas">Máx. filas:</label>
    <input type="number" id="maxFilas" value="50" min="1" max="1000" style="width:70px;">
  </div>

  <button id="generar" onclick="generarExcel()">Generar listado</button>

  <div id="progress-bar">
    <div id="progress-inner">0%</div>
  </div>
  <div id="progreso-texto"></div>

  <script>
    function generarExcel() {
      // Lee parámetros del formulario
      const grupo     = document.getElementById('grupo').value.trim();
      const idioma    = document.getElementById('idioma').value;
      const descuento = Number(document.getElementById('descuento').value) || 0;
      const soloStock = document.getElementById('soloStock').checked;
      const maxFilas  = Number(document.getElementById('maxFilas').value) || 50;

      if (!grupo) {
        alert("Por favor, escribe el nombre del grupo.");
        return;
      }

      document.getElementById('generar').disabled = true;
      document.getElementById('progress-bar').style.display = 'block';
      document.getElementById('progress-inner').style.width = '0%';
      document.getElementById('progress-inner').innerText = '0%';
      document.getElementById('progreso-texto').innerText = 'Iniciando...';

      fetch('/api/genera-excel-final-async', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          grupo, idioma, descuento, soloStock, maxFilas
        })
      })
      .then(r => r.json())
      .then(data => {
        if (!data.jobId) throw new Error('No se recibió jobId');
        pollProgreso(data.jobId);
      })
      .catch(e => {
        document.getElementById('progreso-texto').innerText = 'Error: ' + e.message;
        document.getElementById('generar').disabled = false;
        document.getElementById('progress-bar').style.display = 'none';
      });
    }

    function pollProgreso(jobId) {
      fetch('/api/progreso/' + jobId)
        .then(r => r.json())
        .then(status => {
          if (status.error) {
            document.getElementById('progreso-texto').innerText = 'Error: ' + status.error;
            document.getElementById('generar').disabled = false;
            document.getElementById('progress-bar').style.display = 'none';
            return;
          }
          let pct = status.progress || 0;
          document.getElementById('progress-inner').style.width = pct + '%';
          document.getElementById('progress-inner').innerText = pct + '%';
          if (pct < 100) {
            document.getElementById('progreso-texto').innerText = 'Generando archivo, por favor espere...';
            setTimeout(() => pollProgreso(jobId), 1000);
          } else {
            document.getElementById('progreso-texto').innerText = 'Descargando archivo...';
            descargarArchivo(jobId, status.filename);
          }
        })
        .catch(e => {
          document.getElementById('progreso-texto').innerText = 'Error: ' + e.message;
          document.getElementById('generar').disabled = false;
          document.getElementById('progress-bar').style.display = 'none';
        });
    }

    function descargarArchivo(jobId, filename) {
      fetch('/api/descarga-excel/' + jobId)
        .then(r => r.blob())
        .then(blob => {
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = filename || "listado.xlsx";
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          a.remove();
          document.getElementById('progreso-texto').innerText = '¡Archivo generado!';
          document.getElementById('generar').disabled = false;
          document.getElementById('progress-bar').style.display = 'none';
        })
        .catch(e => {
          document.getElementById('progreso-texto').innerText = 'Error al descargar: ' + e.message;
          document.getElementById('generar').disabled = false;
          document.getElementById('progress-bar').style.display = 'none';
        });
    }
  </script>
</body>
</html>