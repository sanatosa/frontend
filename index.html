<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Generador de Excel B2B</title>
</head>
<body>
  <h1>Generador de Excel B2B</h1>

  <p>Crea listados profesionales para ATOSA</p>
  <form id="excel-form">
    <label for="grupo">Grupo</label>
    <select id="grupo">
      <option>Cargando grupos...</option>
    </select>

    <label for="idioma">Idioma</label>
    <select id="idioma">
      <option>Español</option>
      <option>Inglés</option>
      <option>Francés</option>
      <option>Italiano</option>
    </select>

    <label for="descuento">Descuento</label>
    <select id="descuento">
      <option>Sin descuento</option>
      <option>1%</option>
      <option>2%</option>
      <option>3%</option>
      <option>4%</option>
      <option>5%</option>
      <option>6%</option>
      <option>7%</option>
      <option>8%</option>
    </select>

    <label>
      <input type="checkbox" id="soloStock">
      Solo en stock
    </label>
    <label>
      <input type="checkbox" id="sinImagenes">
      Sin imágenes
    </label>

    <label for="email">Email para recibir el archivo (opcional)</label>
    <input type="email" id="email">

    <button type="submit">Generar Excel</button>
  </form>

  <div id="progreso"></div>
  <div id="descargarExcel" style="display:none;">
    <a id="enlaceDescarga" href="#" download>Descargar Excel</a>
  </div>

  <div id="estado"></div>

  <!-- ------------- AÑADIDO SOLO LO SOLICITADO: Altas/Bajas ----------- -->
  <button id="ver-altas-bajas" style="margin-top:1em;">Ver Altas/Bajas Semanales</button>
  <div id="altas-bajas-result" style="margin-top:0.7em;"></div>
  <!-- ----------------------------------------------------------------- -->

  <script>
    // Cargar grupos (asumiendo que ya tienes este bloque)
    window.onload = async function() {
      try {
        const resp = await fetch('/api/grupos');
        const datos = await resp.json();
        const sel = document.getElementById('grupo');
        sel.innerHTML = "";
        datos.grupos.forEach(grupo => {
          const opt = document.createElement('option');
          opt.textContent = grupo;
          sel.appendChild(opt);
        });
      } catch {
        document.getElementById('grupo').innerHTML = '<option>Error de conexión</option>';
      }
    };

    // Evento de generación de excel (asumiendo ya tienes esta lógica)
    document.getElementById('excel-form').onsubmit = async function(e) {
      e.preventDefault();
      // Aquí tu lógica para generar el excel, mostrar progreso, descarga, etc.
    };

    // -------------------------------------------
    // Bloque NUEVO: consulta de altas/bajas semanales
    // -------------------------------------------
    document.getElementById('ver-altas-bajas').onclick = async function() {
      const res = await fetch('/api/altas-bajas');
      if (!res.ok) {
        document.getElementById('altas-bajas-result').innerHTML = 'No hay histórico suficiente para comparar.';
        return;
      }
      const data = await res.json();
      let html = `<p><b>Semana anterior:</b> ${data.semana_anterior}<br>` +
                 `<b>Semana actual:</b> ${data.semana_actual}</p>`;
      html += `<b>Altas</b> (${data.totales.nuevas}):<br>` +
              (data.altas.length ? data.altas.join(', ') : 'Ninguna') + "<br><br>";
      html += `<b>Bajas</b> (${data.totales.eliminadas}):<br>` +
              (data.bajas.length ? data.bajas.join(', ') : 'Ninguna');
      document.getElementById('altas-bajas-result').innerHTML = html;
    };
  </script>
</body>
</html>
