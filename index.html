<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Generador de Excel - ATOSA</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <style>
    body {
      background: #f9f9fb;
      margin: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
      color: #1e293b;
    }
    header {
      background: #7c3aed;
      color: white;
      padding: 24px 0 13px;
      text-align: center;
      box-shadow: 0 1px 6px #0001;
    }
    header h1 {
      font-size: 2.1rem;
      margin: 0;
      font-weight: 700;
      letter-spacing: .8px;
    }

    .card {
      max-width: 450px;
      margin: 34px auto 40px;
      background: #fff;
      border-radius: 22px;
      box-shadow: 0 4px 26px #8b5cf61a;
      padding: 35px 20px 28px 20px;
    }

    .form-row { margin-bottom: 8px;}
    label {
      display: block;
      font-weight: 600;
      margin: 7px 0 2px 2px;
      color: #47417b;
    }
    select,
    .field {
      width: 100%;
      font-size: 1.09rem;
      padding: 11px 10px;
      border-radius: 8px;
      border: 1.4px solid #b7b7d7;
      background: #f6f6fb;
      margin-bottom: 2px;
      box-sizing: border-box;
      font-family: inherit;
      outline: none;
    }
    select:focus, .field:focus { border-color: #a78bfa; background: #f3e8ff;}
    .checks {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 10px 0 17px 0;
      gap: 18px;
    }
    .checks label {
      color: #7c3aed;
      font-weight: 600;
      margin: 0 0 0 5px;
      font-size: 1.01rem;
      display: inline-block;
      vertical-align: middle;
    }
    .checks input[type=checkbox] {
      width: 19px; height: 19px;
      accent-color: #a78bfa;
      margin-left: 0; margin-right: 4px;
      vertical-align: middle;
    }

    .progreso-area {
      margin-top: 23px;
      width: 100%;
    }
    progress {
      width: 100%;
      height: 18px;
      border-radius: 10px;
      accent-color: #7c3aed;
      margin-bottom: 4px;
      background: #f3f3fa;
      box-shadow: 0 0 0 1px #f1ebfa;
    }
    .estado {
      text-align: center;
      font-size: 1.08rem;
      font-weight: 600;
      color: #7c3aed;
      min-height: 20px;
      margin-top: 6px;
    }

    .mensaje-espera {
      margin: 10px 0 16px 0;
      background: #fef9c3;
      border-left: 6px solid #facc15;
      padding: 13px 14px;
      border-radius: 6px;
      font-size: 1.045rem;
      color: #713f12;
      box-shadow: 0 1px 3px #0001
    }

    /* Mensaje de carga de grupos */
    #grupo-cargando {
      margin-bottom:10px; 
      font-style:italic; 
      color:#7c3aed;
    }

    @media (max-width: 600px) {
      .card { margin: 17px 5vw 30px 5vw; }
      header h1 { font-size: 1.2rem;}
      label { font-size: .98em;}
      .mensaje-espera { font-size: .98em;}
    }

  </style>
</head>
<body>
  <header>
    <h1>Generador de Excel ¬∑ ATOSA</h1>
  </header>
  <div class="card">
    <form id="formulario">
      <div id="grupo-cargando">Cargando grupos, espere...</div>
      <div class="form-row">
        <select id="grupo" style="display:none;"></select>
      </div>
      <div class="form-row">
        <label for="idioma">Idioma:</label>
        <select id="idioma">
          <option value="Espa√±ol">Espa√±ol</option>
          <option value="Ingl√©s">Ingl√©s</option>
          <option value="Franc√©s">Franc√©s</option>
          <option value="Italiano">Italiano</option>
        </select>
      </div>
      <div class="form-row">
        <label for="descuento">Descuento (%):</label>
        <select id="descuento">
          <option>0</option><option>1</option><option>2</option>
          <option>3</option><option>4</option><option>5</option>
          <option>6</option><option>7</option><option>8</option>
        </select>
      </div>
      <div class="checks">
        <label><input type="checkbox" id="soloStock"> Solo en stock</label>
        <label><input type="checkbox" id="sinImagenes"> Sin im√°genes</label>
      </div>
      <div class="mensaje-espera" id="mensaje-espera" style="display:none;">
        <b>‚è≥ Excel en proceso‚Ä¶</b><br>
        Por favor, <u>no cierres esta ventana</u> mientras se completa.<br>
        Esto puede tardar varios minutos si hay muchas im√°genes.
      </div>
      <button type="submit" id="generar">Generar Excel</button>
      <div class="progreso-area">
        <progress id="progreso" value="0" max="100"></progress>
        <div class="estado" id="estado"></div>
      </div>
    </form>
  </div>
  <script>
    const API = "https://backend-aqb5.onrender.com";
    const grupoSelect = document.getElementById("grupo");
    const grupoCargando = document.getElementById("grupo-cargando");
    const estado = document.getElementById("estado");
    const progreso = document.getElementById("progreso");
    const mensaje = document.getElementById("mensaje-espera");

    grupoCargando.style.display = "block";
    grupoSelect.style.display = "none";

    fetch(API + "/api/grupos")
      .then(r => r.json())
      .then(({ grupos }) => {
        grupoSelect.innerHTML = "";
        grupos.forEach(gr => {
          const op = document.createElement("option");
          op.value = gr;
          op.textContent = gr;
          grupoSelect.appendChild(op);
        });
        grupoCargando.style.display = "none";
        grupoSelect.style.display = "block";
      })
      .catch(() => {
        grupoCargando.textContent = "No se pudieron cargar los grupos. Intente otra vez m√°s tarde.";
      });

    document.getElementById("formulario").onsubmit = async function(e) {
      e.preventDefault();
      mensaje.style.display = "block";
      progreso.value = 0;
      estado.textContent = "‚è≥ Iniciando...";
      document.getElementById("generar").disabled = true;
      const grupo = document.getElementById("grupo").value;
      const idioma = document.getElementById("idioma").value;
      const descuento = parseInt(document.getElementById("descuento").value, 10);
      const soloStock = document.getElementById("soloStock").checked;
      const sinImagenes = document.getElementById("sinImagenes").checked;
      const res = await fetch(API + "/api/genera-excel-final-async", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ grupo, idioma, descuento, soloStock, sinImagenes })
      });
      const { jobId } = await res.json();
      consultaProgreso(jobId);
    };
    async function consultaProgreso(jobId) {
      let descargado = false;
      const intervalo = setInterval(async () => {
        const res = await fetch(API + "/api/progreso/" + jobId);
        const data = await res.json();
        progreso.value = data.progress || 0;
        if (data.error) {
          estado.textContent = "‚ùå Error: " + data.error;
          clearInterval(intervalo);
          document.getElementById("generar").disabled = false;
          mensaje.style.display = "none";
          return;
        }
        if (data.progress >= 100 && !descargado) {
          descargado = true;
          estado.textContent = "‚úÖ Excel generado. Descargando...";
          clearInterval(intervalo);
          const res = await fetch(API + "/api/descarga-excel/" + jobId);
          const blob = await res.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = data.filename || "listado.xlsx";
          a.click();
          estado.textContent = "‚úÖ Excel descargado con √©xito.";
          mensaje.style.display = "none";
          document.getElementById("generar").disabled = false;
        } else {
          estado.textContent = `üõ†Ô∏è ${data.fase || "Generando"} ‚Äî ${data.progress}%`
            + (data.eta != null ? ` ‚Äî ETA: ${data.eta} s` : "");
        }
      }, 1200);
    }
  </script>
</body>
</html>
