<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Generador de Excel B2B ATOSA</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; }
    label { font-weight: bold; }
    select, input, button { margin: 8px 0 16px; font-size: 15px; }
    #cambios-articulos { margin: 20px 0; border: 1px solid #bbb; padding: 12px; background: #f9f9fa; font-size: 14px; }
  </style>
</head>
<body>
  <h1>Generador de Excel B2B ATOSA</h1>
  <form id="excel-form">
    <div>
      <label for="grupo">Grupo</label><br>
      <select id="grupo" name="grupo" required></select>
    </div>
    <div>
      <label for="idioma">Idioma</label><br>
      <select id="idioma" name="idioma">
        <option value="Español">Español</option>
        <option value="Inglés">Inglés</option>
        <option value="Francés">Francés</option>
        <option value="Italiano">Italiano</option>
      </select>
    </div>
    <div>
      <label for="descuento">Descuento</label><br>
      <select id="descuento" name="descuento">
        <option value="0">Sin descuento</option>
        <option value="1">1%</option>
        <option value="2">2%</option>
        <option value="3">3%</option>
        <option value="4">4%</option>
        <option value="5">5%</option>
        <option value="6">6%</option>
        <option value="7">7%</option>
        <option value="8">8%</option>
      </select>
    </div>
    <div>
      <label><input type="checkbox" id="soloStock" name="soloStock"> Solo en stock</label>
    </div>
    <div>
      <label><input type="checkbox" id="sinImagenes" name="sinImagenes"> Sin imágenes</label>
    </div>
    <div>
      <label for="email">Email para recibir el archivo (opcional)</label><br>
      <input type="email" id="email" name="email" autocomplete="off" style="width:280px">
    </div>
    <button type="submit">Generar Excel</button>
    <span id="progreso"></span>
    <a id="descargar" style="display:none; margin-left:12px;">Descargar Excel</a>
  </form>

  <hr>

  <button id="ver-cambios">Ver cambios de artículos</button>
  <div id="cambios-articulos">
    <!-- Aquí aparecerán los cambios de altas y bajas -->
  </div>

  <script>
    // Cargar lista de grupos al iniciar
    async function cargarGrupos() {
      const resp = await fetch('/api/grupos');
      const data = await resp.json();
      const sel = document.getElementById('grupo');
      sel.innerHTML = '';
      data.grupos.forEach(grupo => {
        const opt = document.createElement('option');
        opt.value = grupo;
        opt.textContent = grupo;
        sel.appendChild(opt);
      });
    }
    cargarGrupos();

    // Envío de formulario para generar Excel
    document.getElementById('excel-form').onsubmit = async function(e) {
      e.preventDefault();
      document.getElementById('progreso').textContent = 'Preparando generación...';
      document.getElementById('descargar').style.display = 'none';
      const body = {
        grupo: document.getElementById('grupo').value,
        idioma: document.getElementById('idioma').value,
        descuento: parseInt(document.getElementById('descuento').value, 10),
        soloStock: document.getElementById('soloStock').checked,
        sinImagenes: document.getElementById('sinImagenes').checked,
      };
      const email = document.getElementById('email').value.trim();
      if (email) body.email = email;

      const resp = await fetch('/api/genera-excel-final-async', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      const data = await resp.json();
      if (data.jobId) {
        comprobarProgreso(data.jobId);
      } else {
        document.getElementById('progreso').textContent = 'Error al iniciar la generación.';
      }
    };

    // Comprobar progreso y descargar
    async function comprobarProgreso(jobId) {
      const progreso = document.getElementById('progreso');
      const enlace = document.getElementById('descargar');
      progreso.textContent = 'Preparando archivo...';
      let intv = setInterval(async () => {
        const res = await fetch('/api/progreso/' + jobId);
        const dat = await res.json();
        progreso.textContent = `Progreso: ${dat.progress || 0}% - ${dat.fase || ''}` + (dat.eta ? ` (ETA: ${dat.eta}s)` : '');
        if (dat.error) {
          clearInterval(intv);
          progreso.textContent = 'Error: ' + dat.error;
        }
        if (dat.progress === 100 && dat.filename) {
          clearInterval(intv);
          progreso.textContent = '¡Completado!';
          enlace.style.display = '';
          enlace.href = '/api/descarga-excel/' + jobId;
          enlace.download = dat.filename;
          enlace.textContent = 'Descargar Excel';
        }
      }, 1000);
    }

    // Cambios de artículos: altas y bajas
    document.getElementById('ver-cambios').onclick = async function() {
      const res = await fetch('/api/cambios-articulos');
      const data = await res.json();
      let html = `<p><b>${data.resumen.numAltas}</b> altas, <b>${data.resumen.numBajas}</b> bajas</p>`;
      html += "<b>Altas:</b><br>" + (data.nuevas.length ? data.nuevas.join(', ') : 'Ninguna') + "<br>";
      html += "<b>Bajas:</b><br>" + (data.bajas.length ? data.bajas.join(', ') : 'Ninguna');
      document.getElementById('cambios-articulos').innerHTML = html;
    };
  </script>
</body>
</html>
